package {{PACKAGE_NAME}}.tests.pages

import androidx.test.uiautomator.By
import androidx.test.uiautomator.UiDevice
import androidx.test.uiautomator.UiObject2
import {{PACKAGE_NAME}}.testenv.TestTags

/**
 * Page object for the Login screen.
 */
class LoginPage(device: UiDevice) : BasePage(device) {

    override val readyMarker = TestTags.Auth.Login.TITLE

    // ----- Elements -----

    val titleText: UiObject2?
        get() = device.findObject(By.res(TestTags.Auth.Login.TITLE))

    val usernameField: UiObject2?
        get() = device.findObject(By.res(TestTags.Auth.Login.USERNAME_INPUT))

    val passwordField: UiObject2?
        get() = device.findObject(By.res(TestTags.Auth.Login.PASSWORD_INPUT))

    val loginButton: UiObject2?
        get() = device.findObject(By.res(TestTags.Auth.Login.SUBMIT_BUTTON))

    val forgotPasswordLink: UiObject2?
        get() = device.findObject(By.res(TestTags.Auth.Login.FORGOT_PASSWORD_LINK))

    val errorMessage: UiObject2?
        get() = device.findObject(By.res(TestTags.Auth.Login.ERROR_MESSAGE))

    // ----- Actions -----

    /**
     * Enter username.
     */
    fun enterUsername(username: String): LoginPage {
        usernameField?.text = username
        return this
    }

    /**
     * Enter password.
     */
    fun enterPassword(password: String): LoginPage {
        passwordField?.text = password
        return this
    }

    /**
     * Tap login button.
     */
    fun tapLogin(): LoginPage {
        loginButton?.click()
        return this
    }

    /**
     * Complete login flow, returning HomePage on success.
     */
    fun login(username: String, password: String): HomePage {
        enterUsername(username)
        enterPassword(password)
        tapLogin()
        return HomePage(device).waitForReady()
    }

    /**
     * Attempt login expecting an error.
     */
    fun loginExpectingError(username: String, password: String): LoginPage {
        enterUsername(username)
        enterPassword(password)
        tapLogin()

        // Wait for error to appear
        device.wait(
            androidx.test.uiautomator.Until.hasObject(
                By.res(TestTags.Auth.Login.ERROR_MESSAGE)
            ),
            defaultTimeout
        )

        return this
    }

    // ----- Assertions -----

    /**
     * Assert error message is displayed with specific text.
     */
    fun assertErrorMessage(expectedText: String): LoginPage {
        val error = errorMessage
        require(error != null) { "Error message not displayed" }
        require(error.text == expectedText) {
            "Expected error '$expectedText' but got '${error.text}'"
        }
        return this
    }
}
